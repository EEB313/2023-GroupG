---
title: "EEB313 Project"
author: "Group G"
output:
  pdf_document: default
  html_notebook: default
---

## Packages

```{r setup}
library(tidyverse)
library(readxl)
library(lme4)
library(lmerTest)
```


# Import Data and Wrangling (sorted by dataset)

## Emerald Ash Borer Data

```{r download_EAB_data}
raw_eab_data <- read_excel("emerald-ash-borer-surveillance-data-2002-to-2020-en.xlsx")

# change column names from all uppercase to all lowercase to make it easier to work with
colnames(raw_eab_data) <- c("latitude", "longitude", "survey", "year",
                            "province", "community", "result")

# separate dataset for Ontario only and keep only necessary columns
ont_eab_data <- raw_eab_data %>% subset(province == "ONTARIO")
ont_eab_data <- ont_eab_data[, c(1, 2, 4, 6, 7)]

# remove NAs from community for future matching
ont_eab_data <- ont_eab_data %>% subset(!is.na(community))

# remove communities with less than 10 observations
keep_communities <- ont_eab_data %>% group_by(community) %>% count() %>% filter(n >= 10)
ont_eab_data <- ont_eab_data %>% subset(ont_eab_data$community %in% keep_communities$community)
```


Some of community names in our EAB data include designations that are common to more than one community (ex. County, District, etc) and although some of the census data names also have this feature, we can't guess whether the corresponding communities will be formatted the same way (ex. will "Bruce County" in our EAB data be written as "Bruce" or "Bruce County" in the census?). However, the designation may help us in our report later on when we have to talk about the different communities. That's why instead of changing our existing community names, I created a new column of the names with the designations removed. We will also do the same thing to the census data after downloading it.

```{r edit_community_names}
ont_eab_data <- ont_eab_data %>% 
  mutate(community_2 = str_replace_all(ont_eab_data$community,
                        c(" COUNTY" = "", " DISTRICT" = "", " DIVISION" = "", 
                          " REGIONAL MUNICIPALITY" = "", " MUNICIPALITY" = "",
                          " UNITED COUNTIES" = "")))
```


## Population Density Data

To determine whether the communities in our EAB data are urban or rural, we decided to use the Canadian 2021 census from Statistics Canada. We found a dataset containing only census information for population centres in Canada. According to StatCan, population centres are communities that have a population of at least 1000 people and a population density of at least 400 people per square kilometre. Locations that don't meet these requirements are considered rural. If the communities from our EAB data are found in the population centres data, we can identify them as urban, and if they are missing, they will be rural. Since the dataset is for all of Canada, we will also subset to only population centres in Ontario.

```{r download_urban_data}
# download census 2021 data for population centres and unzip file
temp <- tempfile() 
download.file("https://www150.statcan.gc.ca/n1/tbl/csv/98100011-eng.zip", temp)
census_2021_pop_centres <- read.csv(unz(temp, "98100011.csv"))
unlink(temp)
```


```{r subsetting_census_data}
# subset dataframe to Ontario only and 
# keep name, population, and population density columns
## to exclude the rows for the provinces themselves, the chosen rows are
## 1 after the Ontario row and 1 before the Manitoba row
census_2021_pop_centres <- census_2021_pop_centres[380:681, c(2, 3, 5, 17)]

# simplify column names
colnames(census_2021_pop_centres) <- c("community_name", "DGUID", 
                                       "population_2021", "pop_density_2021")


# new column with designations removed
census_2021_pop_centres <- census_2021_pop_centres %>% 
  filter(!is.na(community_name)) %>% 
  mutate(community_name_2 = str_replace_all(census_2021_pop_centres$community_name,
                        c(" County" = "", " District" = "", " Division" = "", 
                          " Regional Municipality" = "", " Municipality" = "")))
```


Now that we have data for the urban communities, the next step is to match the community names from our EAB data to the census data and determine the community type. We made an empty column 'community_type' in our EAB data so that we can use a for loop to populate it. 

```{r match_community_names}
ont_eab_data$community_type <- NA  # new column for community type

for (i in 1:nrow(ont_eab_data)) {  # look through every row in our EAB data
  
  j <- which(tolower(ont_eab_data$community_2[i]) == 
             tolower(census_2021_pop_centres$community_name_2))
  # find this row's community in column of census data community names
  # searching for identical names -> NO partial matches
  # returns row number of matching name or integer (0) if no matching name found
  
  if (!identical(j, integer (0))) {   # if row number returned
    ont_eab_data$community_type[i] <- "urban"
    
  } else {
    ont_eab_data$community_type[i] <- "rural"
    
  }
    
  
}
```


## Temperature Data

```{r download_weather_data}
temperature_data <- read_excel("EEB313_EAB_weather_1.xlsx")
temperature_data <- temperature_data[,1:3] # remove unnecessary columns
```

```{r add_temp_to_primary_data}
ont_eab_data$avg_temp <- NA  # new column for temperature

for (i in 1:nrow(ont_eab_data)) {  # look through every row in our EAB data
  
  k <- which(tolower(ont_eab_data$community[i]) == 
             tolower(temperature_data$Community))
  # return row number of matching community name
  
  ont_eab_data$avg_temp[i] <- temperature_data$Avg_Temp[k]
      
      
}

```


## Methods

### Model 1: Time

Has EAB abundance changed over the years in different Ontario communities?

* Number of observations for each community differ
* Locations within each community are different (with some same locations between years)


```{r result_on_year_model}
# effect of time on EAB abundance
time_glm_model <- glm(as.factor(result) ~ year, 
                      family = binomial, data = ont_eab_data)
summary(time_glm_model)
anova(time_glm_model, test = "Chi")
```

```{r result_on_year_community_model}

# effect of time on EAB abundance by community
time_community_model <- glm(as.factor(result) ~ year * community, 
                      family = binomial, data = ont_eab_data)

anova(time_community_model, test="Chi")
```


### Model 2: Latitude and Longitude

```{r result_on_year_coords_model}
# effect of latitude and longitude and their interaction on EAB detection
coordinates_glm_model <- glm(as.factor(result) ~ year * latitude * longitude, 
                             family = binomial, data = ont_eab_data)
summary(coordinates_glm_model)
```


#### Is there a relationship between coordinates and community type?

```{r communitytype_on_coords_model}
# latitude and longitude and their interaction on community type
coord_type_model <- glm(as.factor(community_type) ~ latitude * longitude, 
                        family = binomial, data = ont_eab_data)
summary(coord_type_model)
```


#### Is there a relationship between coordinates and mean temperature?

```{r temp_on_coords_model}
# latitude and longitude and their interaction on mean temperature
coord_temp_model <- lm(avg_temp ~ latitude * longitude, data = ont_eab_data)
summary(coord_temp_model)
```


### Model 3: Community Type

```{r communitytype_detections_table}
# effect of community type on EAB abundance
types_result <- table(ont_eab_data$community_type, ont_eab_data$result)
types_result
```

```{r result_on_communitytype_model}
# effect of community type on EAB detection over the years
community_type_model <- glm(as.factor(result) ~ community_type, 
                  family = binomial, data = ont_eab_data)
summary(community_type_model)
```


### Model 4: Temperature

```{r result_on_year_temp_model}
temp_model <- glm(as.factor(result) ~  year + avg_temp, 
                  family = binomial, data = ont_eab_data)
summary(temp_model)
```
  

### Model 5: Community Type and Temperature Model

```{r result_on_year_communitytype_model}
temp_type_model <- glm(as.factor(result) ~ avg_temp * community_type, 
                  family = binomial, data = ont_eab_data)
summary(temp_type_model)
```


## Results

### Model 1: Time

```{r detections_over_time_graph}
result_colour <- c("#FF0000", "#3333CC")

ggplot(ont_eab_data, aes(x = year, fill = result)) +
  geom_histogram(stat = "count") +
  scale_x_continuous(breaks = seq(2002, 2020, by = 2)) +
  theme_bw() +
  scale_fill_manual(values = result_colour) +
  labs(title = "EAB Detection Throughout Time", x = "Year", y = "Observation Count", fill = "Detection Result")
```
As you can see, the observations are skewed through the years. The greatest number of observations happened between the years 2003 and 2010, which corresponds with some of the first recorded incidences of the EAB in North America. The most-important takeaway from this graph is the frequency of observations within this dataset changed significantly more over time than the abundance of EABs did. Furthermore, this change in observation frequency over the years makes it harder to compare and contrast detection rate through the years.

### Model 2: Latitude + Longitude

```{r detections_by_coords_graph, fig.asp = 0.5, fig.width = 8.5}
ggplot(ont_eab_data, aes(x = longitude, y = latitude, color = result)) +
  geom_point(size = 0.8, alpha = 0.6) +
  theme_bw() +
  scale_color_manual(values = result_colour) +
  labs(title = "EAB Detection in Ontario by Longitude & Latitude", x = "Longitude", y = "Latitude", color = "Detection Result")
```
EAB detection is concentrated in one general area!

```{r communitytype_by_coords_model, fig.asp = 0.5, fig.width = 8.5}
colour <- c(rural = "forestgreen", urban = "darkgrey")

ggplot(ont_eab_data, aes(x = longitude, y = latitude, color = community_type)) +
  geom_point(size = 0.8, alpha = 0.6) +
  theme_bw() +
  scale_color_manual(values = colour) +
  labs(title = "Community Type in Ontario by Longitude & Latitude", x = "Longitude", y = "Latitude", color = "Community Type")
```
There IS a correlation between coordinates and community type

```{r temp_by_coords_graph, fig.asp = 0.5, fig.width = 8.5}
ggplot(ont_eab_data, aes(x = longitude, y = latitude, color = avg_temp)) +
  geom_point(size = 1, alpha = 0.3) +
  theme_bw() +  
  labs(title = "Annual Average Temperature in Ontario by Longitude & Latitude", x = "Longitude", y = "Latitude", color = "Average Annual Temperature (˚C)")
```


### Model 3: Community Type

```{r detection_by_year_community_type_graph, fig.asp = 0.5, fig.width = 8.5}
ont_eab_data %>% 
  ggplot(aes(x = year, fill = community_type)) + 
  geom_histogram(binwidth = 1.2) + 
  facet_wrap(~result, scales = "free_y") +
  scale_x_continuous(breaks = seq(2002, 2020, by = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_fill_manual(values = colour) +
  labs(title = "EAB Detection by Year and Community Type", x = "Year", y = "Number of Observations", 
       fill = "Community Type")
```
Note the differences in y-axis scales between "Detected" and "Not Detected", as well as the significantly higher number of observations in the earlier half of the dataset.

```{r detection_by_year_community_type_graph2}
ggplot(ont_eab_data, aes(x = result, y = year, fill = result)) + 
  geom_boxplot() + 
  geom_point(size = 0.6, alpha = 0.4) + facet_wrap(~community_type) +
  theme_bw() +
  scale_fill_manual(values = result_colour) +
  labs(title = "EAB Detection by Year and Community Type", x = "", y = "Year", fill = "Detection Result")
```

```{r detection_by_year_community_type_graph3}
ggplot(ont_eab_data, aes(x = result, y = year, fill = result)) + 
  geom_violin() + 
  facet_wrap(~community_type) +
  theme_bw() +
  scale_fill_manual(values = result_colour) +
  labs(title = "EAB Detection by Year and Community Type", x = "", y = "Year", fill = "Detection Result")
```


```{r detection_by_year_community_type_graph4}
ggplot(ont_eab_data, aes(x = community_type, y = year, fill = community_type)) + 
  geom_violin() + 
  facet_wrap(~result) +
  theme_bw() +
  scale_fill_manual(values = colour) +
  labs(title = "EAB Detection by Year and Community Type", x = "", y = "Year", fill = "Community Type")
```


```{r detection_by_year_community_type_graph5}
ggplot(ont_eab_data, aes(x = year, y = community_type, fill = community_type)) + 
  geom_violin() + 
  facet_wrap(~result) +
  theme_bw() +
  scale_x_continuous(breaks = seq(2002, 2020, by = 2)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_fill_manual(values = colour) +
  labs(title = "EAB Detection by Year and Community Type", x = "Year", y = "", fill = "Community Type")
```


### Communities Dominating the Observations

```{r observations_by_community_graph}
community_count <- ont_eab_data %>% 
  count(community, wt = NULL, sort = TRUE)
total_dataframe <- cbind(temperature_data, community_count)
most_observations <- total_dataframe %>% 
  filter(n >= 200)

ggplot(most_observations, aes(x = community, y = n)) + 
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(x = "Community", y = "Observations per Community", title = "Number of Observations from Each Community (n ≥ 200)")
```
Chatham-Kent Division (rural)

```{r detections_chatham_kent_graph}
ont_eab_data %>% 
  filter(community == "CHATHAM-KENT DIVISION") %>% 
ggplot(aes(x = year, fill = result)) +
  geom_histogram(stat = "count") +
  theme_bw() +
  scale_fill_manual(values = result_colour) +
  labs(title = "EAB Detection by Year in the Chatham-Kent Division", x = "Year", y = "Number of Observations", fill = "Detection Result")
```
Our dataset is dominated by a couple of communities especially during the early years of data collection.


### Model 4: Temperature

```{r detections_by_year_temp_graph, fig.asp = 0.5, fig.width = 8.5}
ggplot(ont_eab_data, aes(x = year, y = avg_temp, color = result)) +
  geom_point() +
  geom_smooth(method = "glm", family = "binomial", se = FALSE) +
  scale_color_manual(values = result_colour) +
  theme_bw() +
  labs(title = "EAB Detection Through Time as a Function of Temperature", x = "Year", y = "Average Temperature (˚C)", color = "Detection Result")
```


```{r detections_by_year_temp_graph2, fig.asp = 0.5, fig.width = 15}
ggplot(ont_eab_data, aes(x = community, y = avg_temp, color = result)) +
  geom_point() +
  scale_color_manual(values = result_colour) +
  theme(axis.text.x = element_text(angle = 70, vjust = 0.5, hjust = 1)) +
  theme_bw() +
  labs(title = "EAB Detection Through Time as a Function of Temperature", x = "Year", y = "Average Temperature (˚C)", color = "Detection Result")
```


### Model 5: Community Type AND Temperature

```{r detections_by_year_temp_type_graph, fig.asp = 0.5, fig.width = 8.5}
ggplot(ont_eab_data, aes(x = year, y = avg_temp, color = result)) + 
  geom_point() +
  facet_wrap(~community_type) +
  theme_bw() +
  scale_x_continuous(breaks = seq(2002, 2020, by = 2)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_color_manual(values = result_colour) +
  labs(title = "EAB Detection by Year, Temperature and Community Type", x = "Year", y = "Average Annual Temperature (˚C)", color = "Detection Result")
```

```{r detections_by_year_temp_type_graph2}
ggplot(ont_eab_data, aes(x = year, y = avg_temp, color = community_type)) +
  geom_point() +
  facet_wrap(~result) +
  scale_color_manual(values = colour) +
  theme_bw() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_x_continuous(breaks = seq(2002, 2020, by = 2)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(title = "EAB Detection by Year, Temperature and Community Type", x = "Year", y = "Average Annual Temperature (˚C)", color = "Community Type")
```

```{r detections_by_year_temp_type_graph3}
ggplot(ont_eab_data, aes(x = avg_temp, y = result, fill = community_type)) +
  geom_violin() +
  scale_fill_manual(values = colour) +
  theme_bw() +
  labs(title = "EAB Detection by Year, Temperature and Community Type", x = "Temperature", y = "Average Annual Temperature (˚C)", color = "Community Type")
```

```{r}
kruskal.test(result ~ avg_temp*community,
             data = ont_eab_data)
```

```{r}
temp_model <- glm(as.factor(result)~ avg_temp + (1|community), family = "binomial", data = ont_eab_data)
summary(temp_model)
```








