---
title: "EEB313 Project: Population Data Wrangling"
author: "Group G"
output: html_notebook
---

## Packages

```{r setup}
library(tidyverse)
library(readxl)
```


# Import Data and Wrangling (sorted by dataset)

## Emerald Ash Borer Data

```{r download_EAB_data}
raw_eab_data <- read_excel("emerald-ash-borer-surveillance-data-2002-to-2020-en.xlsx")

# change column names from all uppercase to all lowercase to make it easier to work with
colnames(raw_eab_data) <- c("latitude", "longitude", "survey", "year", "province", "community", "result")

# add column with numerical binary for result ("NOT DETECTED" == 0 and "DETECTED" == 1)
raw_eab_data <- raw_eab_data %>% mutate(EAB_status  = ifelse(result == "NOT DETECTED", 0, 1))

# separate dataset for Ontario only and keep only necessary columns
ont_eab_data <- raw_eab_data %>% subset(province == "ONTARIO")
ont_eab_data <- ont_eab_data[, c(1, 2, 4, 6, 7, 8)]

# remove NAs from community for future matching
ont_eab_data <- ont_eab_data %>% subset(!is.na(community))
```


Some of community names in our EAB data include designations that are common to more than one community (ex. County, District, etc) and although some of the census data names also have this feature, we can't guess whether the corresponding communities will be formatted the same way (ex. will "Bruce County" in our EAB data be written as "Bruce" or "Bruce County" in the census?). However, the designation may help us in our report later on when we have to talk about the different communities. That's why instead of changing our existing community names, I created a new column of the names with the designations removed. We will also do the same thing to the census data after downloading it.

```{r edit_community_names}
ont_eab_data <- ont_eab_data %>% 
  mutate(community_2 = str_replace_all(ont_eab_data$community,
                        c(" COUNTY" = "", " DISTRICT" = "", " DIVISION" = "", 
                          " REGIONAL MUNICIPALITY" = "", " MUNICIPALITY" = "",
                          " UNITED COUNTIES" = "")))
```


## Population Density Data

To determine whether the communities in our EAB data are urban or rural, we decided to use the Canadian 2021 census from Statistics Canada. We found a dataset containing only census information for population centres in Canada. According to StatCan, population centres are communities that have a population of at least 1000 people and a population density of at least 400 people per square kilometre. Locations that don't meet these requirements are considered rural. If the communities from our EAB data are found in the population centres data, we can identify them as urban, and if they are missing, they will be rural. Since the dataset is for all of Canada, we will also subset to only population centres in Ontario.

```{r download_urban_data}
# download census 2021 data for population centres and unzip file
temp <- tempfile() 
download.file("https://www150.statcan.gc.ca/n1/tbl/csv/98100011-eng.zip", temp)
census_2021_pop_centres <- read.csv(unz(temp, "98100011.csv"))
unlink(temp)
```


```{r}
# subset dataframe to Ontario only and 
# keep name, population, and population density columns
## to exclude the rows for the provinces themselves, the chosen rows are 1 after the Ontario row
## and 1 before the Manitoba row
census_2021_pop_centres <- census_2021_pop_centres[380:681, c(2, 3, 5, 17)]

# simplify column names
colnames(census_2021_pop_centres) <- c("community_name", "DGUID", "population_2021", "pop_density_2021")


# new column with designations removed
census_2021_pop_centres <- census_2021_pop_centres %>% 
  filter(!is.na(community_name)) %>% 
  mutate(community_name_2 = str_replace_all(census_2021_pop_centres$community_name,
                        c(" County" = "", " District" = "", " Division" = "", 
                          " Regional Municipality" = "", " Municipality" = "")))
```


Now that we have data for the urban communities, the next step is to match the community names from our EAB data to the census data and determine the community type. We made an empty column 'community_type' in our EAB data so that we can use a for loop to populate it

Below is the code for matching community names. We should consider changing this into a function as well. The purpose of this code is to:

1) For each community name in our EAB data, search for the same name in the census data, 

2) Save the row number of the first census community name that is an exact match in a new variable, 

    * If there is no match, the returned value would be an empty integer (integer (0))
    
3) If row number != integer (0), append "urban' to empty columns in our EAB data, else append 'rural'. 

```{r match_community_names}
# match community names from EAB data with geographic names in census_2021_pop_centres
# to keep population data only for communities we have EAB data for

for (i in 1:nrow(ont_eab_data)){
  
  # create a new variable with the row number of the matching community name in ont_population
  ## case insensitive because EAB data is all uppercase and census data only has first letter capitalized
  j <- grep(ont_eab_data$community[i], ont_population$community_name, ignore.case = TRUE)

  # if matching community name was found, row number will NOT equal integer (0)
  if (!identical(j, integer (0))) {
  
  ont_eab_data$population_2021[i] = ont_population$population_2021[j]
  ont_eab_data$pop_density_2021[i] = ont_population$pop_density_2021[j]

  }
  
}

```




